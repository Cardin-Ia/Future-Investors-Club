<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Investors Club Leaderboard</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="site-header">
    <h1>Investors Club Leaderboard</h1>
    <p class="subtitle">Updated by officers every few days</p>
  </header>

  <main class="container">
    <!-- Leaderboard -->
    <section class="card board">
      <div class="board-header">
        <h2>Current Standings</h2>
        <span id="last-updated"></span>
      </div>

      <div class="table-wrap">
        <table id="leaderboard">
          <thead>
            <tr>
              <th data-key="Rank" class="sortable">Rank</th>
              <th data-key="Member" class="sortable">Member</th>
              <th data-key="Portfolio Value" class="sortable">Portfolio Value</th>
              <th data-key="Return %" class="sortable">Return %</th>
              <th data-key="Notes">Notes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <p class="tip">This page updates automatically on refresh.</p>
    </section>

    <!-- Market Updates (RSS headlines, no X rate limit) -->
    <section class="card news">
      <h2>Market Updates</h2>
      <p class="subtitle">Latest headlines from MarketWatch</p>

      <ul id="news-list" class="news-list" style="margin:0; padding-left:18px;"></ul>

      <p style="margin-top:8px;">
        <a href="https://www.marketwatch.com/latest-news" target="_blank" rel="noopener">See more on MarketWatch →</a>
        &nbsp;|&nbsp;
        <a href="https://twitter.com/MarketWatch" target="_blank" rel="noopener">View @MarketWatch on X →</a>
      </p>

      <p id="news-error" class="subtitle" style="display:none;">Couldn’t load headlines right now.</p>
    </section>
  </main>

  <!-- Papa Parse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Google Sheet CSV link -->
  <script>
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS8N623kjjzxGNpqxrNsH2eZKK8EPjKO1mHLrp0EqLbzTCZ9HcOchvhllLKdnfMx2DVb9Lb4jUYc6Gd/pub?gid=0&single=true&output=csv";
  </script>

  <!-- Leaderboard logic -->
  <script>
    const tbody = document.querySelector("#leaderboard tbody");
    const lastUpdatedEl = document.getElementById("last-updated");

    function parseCurrency(s){ return parseFloat((s||"").replace(/[^0-9.-]/g,"")); }
    function parsePercent(s){ return parseFloat((s||"").replace(/%/g,"")); }

    function renderTable(rows){
      tbody.innerHTML = "";
      rows.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r["Rank"] ?? ""}</td>
          <td>${r["Member"] ?? ""}</td>
          <td>${r["Portfolio Value"] ?? ""}</td>
          <td>${r["Return %"] ?? ""}</td>
          <td>${r["Notes"] ?? ""}</td>`;
        tbody.appendChild(tr);
      });
    }

    function sortByKey(rows,key,numeric=false){
      const copy=[...rows];
      copy.sort((a,b)=>{
        const A=a[key]??"", B=b[key]??"";
        if(numeric){
          const x=key==="Return %"?parsePercent(A):parseCurrency(A);
          const y=key==="Return %"?parsePercent(B):parseCurrency(B);
          if(isNaN(x)&&isNaN(y))return 0;
          if(isNaN(x))return 1;
          if(isNaN(y))return -1;
          return y-x;
        }
        return (""+A).localeCompare(""+B);
      });
      return copy;
    }

    function attachSorting(rows){
      document.querySelectorAll("th.sortable").forEach(th=>{
        let asc=false;
        th.addEventListener("click",()=>{
          const key=th.dataset.key;
          const numeric=["Portfolio Value","Return %","Rank"].includes(key);
          let sorted=sortByKey(rows,key,numeric);
          if(asc)sorted.reverse();
          asc=!asc;
          renderTable(sorted);
        });
      });
    }

    function updateTimestamp(){
      lastUpdatedEl.textContent="Refreshed: "+new Date().toLocaleString();
    }

    function loadCSV(){
      Papa.parse(SHEET_CSV_URL,{
        download:true,header:true,
        complete:res=>{
          const rows=res.data.filter(r=>Object.values(r).some(v=>v&&String(v).trim()!==""));
          let sorted=rows;
          if(rows[0]&&"Rank"in rows[0])
            sorted=rows.slice().sort((a,b)=>(parseFloat(a["Rank"])||999)-(parseFloat(b["Rank"])||999));
          else if(rows[0]&&"Return %" in rows[0])
            sorted=sortByKey(rows,"Return %",true);
          renderTable(sorted);
          attachSorting(rows);
          updateTimestamp();
        },
        error:err=>{
          tbody.innerHTML="<tr><td colspan='5'>Error loading leaderboard.</td></tr>";
          console.error(err);
        }
      });
    }
    loadCSV();
  </script>

  <!-- MarketWatch RSS headline fetcher -->
  <script>
    (function(){
      const RSS_URL = 'https://www.marketwatch.com/rss/topstories';
      const PROXIES = [
        url => 'https://api.allorigins.win/get?url=' + encodeURIComponent(url),
        url => 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(url)
      ];
      const listEl = document.getElementById('news-list');
      const errEl  = document.getElementById('news-error');

      async function fetchWithFallback(url){
        let lastErr;
        for (const wrap of PROXIES){
          const proxied = wrap(url);
          try{
            const r = await fetch(proxied, { cache: 'no-store' });
            if (!r.ok) { lastErr = new Error('HTTP ' + r.status); continue; }
            const text = r.headers.get('content-type')?.includes('application/json')
              ? (await r.json()).contents
              : (await r.text());
            return text;
          }catch(e){ lastErr = e; }
        }
        throw lastErr || new Error('All proxies failed');
      }

      function renderRSS(xmlText){
        const xml = new DOMParser().parseFromString(xmlText, 'text/xml');
        const items = Array.from(xml.querySelectorAll('item')).slice(0, 6);
        if (!items.length) throw new Error('No RSS items');
        listEl.innerHTML = items.map(it => {
          const title = it.querySelector('title')?.textContent ?? 'Untitled';
          const link  = it.querySelector('link')?.textContent ?? '#';
          const rawDate = it.querySelector('pubDate')?.textContent;
          const when = rawDate ? new Date(rawDate).toLocaleString() : '';
          const dateSpan = when ? `<span style="color:#aab2bd; font-size:12px;"> — ${when}</span>` : '';
          return `<li style="margin:6px 0;"><a target="_blank" rel="noopener" href="${link}">${title}</a>${dateSpan}</li>`;
        }).join('');
      }

      (async ()=>{
        try{
          const xml = await fetchWithFallback(RSS_URL);
          renderRSS(xml);
        }catch(e){
          console.error('RSS load failed:', e);
          errEl && (errEl.style.display = 'block');
          listEl && (listEl.innerHTML = '');
        }
      })();
    })();
  </script>
</body>
</html>
