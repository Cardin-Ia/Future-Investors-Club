<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Investors Club Leaderboard</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="site-header">
    <h1>Investors Club Leaderboard</h1>
    <p class="subtitle">Updated by officers every few days</p>
  </header>

  <main class="container">
    <!-- Leaderboard -->
    <section class="card board">
      <div class="board-header">
        <h2>Current Standings</h2>
        <span id="last-updated"></span>
      </div>

      <div class="table-wrap">
        <table id="leaderboard">
          <thead>
            <tr>
              <th data-key="Rank" class="sortable">Rank</th>
              <th data-key="Member" class="sortable">Member</th>
              <th data-key="Portfolio Value" class="sortable">Portfolio Value</th>
              <th data-key="Return %" class="sortable">Return %</th>
              <th data-key="Notes">Notes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <p class="tip">This page updates automatically on refresh.</p>
    </section>

    <!-- News panel -->
    <section class="card news">
      <h2>Market Updates</h2>
      <p class="subtitle">Latest from @MarketWatch</p>

      <!-- X embed (shows full tweet text + images when allowed) -->
      <div id="x-embed">
        <a class="twitter-timeline"
           data-tweet-limit="1"
           data-chrome="noheader nofooter noborders transparent"
           data-dnt="true"
           href="https://twitter.com/MarketWatch">Tweets by MarketWatch</a>
      </div>

      <!-- Fallback if X is blocked -->
      <div id="news-fallback" style="display:none">
        <p class="subtitle">Tweet preview blocked on this network. Showing headlines instead:</p>
        <ul id="news-list" class="news-list"></ul>
        <a id="mw-link" class="news-more" href="https://www.marketwatch.com/latest-news" target="_blank" rel="noopener">
          See more on MarketWatch →
        </a>
      </div>
    </section>
  </main>

  <!-- Twitter widget -->
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

  <!-- PapaParse for CSV → leaderboard -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Your Google Sheet CSV URL -->
  <script>
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS8N623kjjzxGNpqxrNsH2eZKK8EPjKO1mHLrp0EqLbzTCZ9HcOchvhllLKdnfMx2DVb9Lb4jUYc6Gd/pub?gid=0&single=true&output=csv";
  </script>

  <!-- Leaderboard logic (keep your existing script.js, or use the one I gave earlier) -->
  <script src="script.js"></script>

  <!-- Fallback logic for news if X is blocked -->
  <script>
    function showFallbackHeadlines() {
      const fb = document.getElementById('news-fallback');
      const list = document.getElementById('news-list');
      const xBox = document.getElementById('x-embed');
      if (!fb || !list || !xBox) return;

      xBox.style.display = 'none';
      fb.style.display = 'block';

      const rss = 'https://www.marketwatch.com/rss/topstories';
      const proxied = 'https://api.allorigins.win/get?url=' + encodeURIComponent(rss);

      fetch(proxied)
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(data => {
          const xml = (new DOMParser()).parseFromString(data.contents, 'text/xml');
          const items = Array.from(xml.querySelectorAll('item')).slice(0, 6);
          list.innerHTML = items.map(it => {
            const title = it.querySelector('title')?.textContent ?? 'Untitled';
            const link = it.querySelector('link')?.textContent ?? '#';
            return `<li><a target="_blank" rel="noopener" href="${link}">${title}</a></li>`;
          }).join('');
        })
        .catch(() => {
          list.innerHTML = `<li>Couldn’t load headlines right now.</li>`;
        });
    }

    // If Twitter widgets don't init within 3s, use fallback
    window.addEventListener('load', () => {
      setTimeout(() => {
        const xLoaded = (window.twttr && window.twttr.widgets);
        if (!xLoaded) showFallbackHeadlines();
      }, 3000);
    });
  </script>
</body>
</html>
